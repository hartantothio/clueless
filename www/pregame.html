<!DOCTYPE html>
<!--[if lt IE 7]>      <html class="no-js lt-ie9 lt-ie8 lt-ie7"> <![endif]-->
<!--[if IE 7]>         <html class="no-js lt-ie9 lt-ie8"> <![endif]-->
<!--[if IE 8]>         <html class="no-js lt-ie9"> <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js"> <!--<![endif]-->
<head>
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<title>Clueless</title>
<meta name="description" content="">
<meta name="viewport" content="width=device-width, initial-scale=1">
<script>
var ws = new WebSocket("ws://home.mbajoras.net:8080/CluelessV1/CluelessServlet"),
    me_id = +$.cookie('player_id'),
    game_id = +getUrlVars()['id'];

ws.send(JSON.stringify({
    cmd: 'KeepAlive',
    playerId: me_id,
    gameId: game_id
}));
</script>
<link rel="stylesheet" href="/css/jquery.fancybox.css" />
<link rel="stylesheet" href="/css/style.css" />
<body>

<h1>Clueless</h1>
<h2>By Team Awareness</h2>
<div id="container">
    <div id="page-pregame">
        <h3></h3>
        <table border="1" cellpadding="5" cellspacing="0">
            <tr>
                <th>Player</th>
                <th>Character</th>
            </tr>
        </table><br />
        <ul class="menu">
            <li><a id="btn-quit" href="/">Main Menu</a></li>
        </ul>
    </div>
</div>

</body>
<script src="//ajax.googleapis.com/ajax/libs/jquery/1.10.2/jquery.min.js"></script>
<script>window.jQuery || document.write('<script src="/js/jquery-1.10.2.min.js"><\/script>')</script>
<script src="/js/jquery.cookie.js"></script>
<script src="/js/jquery.fancybox.min.js"></script>
<script src="/js/plugin.js"></script>
<script>
$(function () {
    var creator_id = null,
        $table = $('table'),
        characters = ['-Random-', 'Professor Plum', 'Mr. Green', 'Colonel Mustard', 'Mrs. White', 'Miss Scarlet', 'Ms. Peacock'];

    $('#btn-quit').on('click', function () {
        ws.send(JSON.stringify({
            cmd: 'PlayerQuit',
            gameId: game_id
        }));
        return false;
    });

    $body.on('change', 'select[name="character"]', function () {
        ws.send(JSON.stringify({
            cmd: 'ChangeCharacter',
            gameId: game_id,
            identity: this.value
        }));
    });

    $body.on('click', '#btn-play', function () {
        ws.send(JSON.stringify({
            cmd: 'StartGame',
            gameId: game_id
        }));
        return false;
    });

    ws.onopen = function () {
        ws.send(JSON.stringify({
            cmd: 'QueryGames',
            playStyle: '',
            secured: ''
        }));
    };

    ws.onmessage = function(message) {
        var data = JSON.parse(message.data),
            i = 0,
            tmp = '',
            tmp_2 = '',
            game = null,
            player = null;

        if (data.cmd === 'QueryGames') {
            if (data.games && data.games.length) {
                for (i = 0; i < data.games.length; i++) {
                    game = data.games[i];
                    if (game.id === game_id) {
                        creator_id = +game.creatorId;
                        $('h3').html(game.name);
                        for (i = 0; i < game.players.length; i++) {
                            player = game.players[i];
                            characters.remove(player.character);
                            tmp_2 = '<tr class="placeholder"><td>' + (i+1) + '</td><td>' + player.character + '</td></tr>';
                            if (player.id === me_id) {
                                tmp = tmp_2 + tmp;
                            } else {
                                tmp += tmp_2;
                            }
                        }

                        if (game.players.length >= 3 && me_id === creator_id) {
                            $('.menu').append('<li><a id="btn-play" href="/game.html?id=' + game_id + '">Play!</a></li>');
                        }
                        break;
                    }
                }

                // remove 2nd tr ++
                $table.find('.placeholder').remove();
                $table.append(tmp);

                // replace the first one with select bo
                tmp = '';
                tmp_2 = $table.find('tr:eq(1)').find('td:eq(1)');
                player = tmp_2.text();
                tmp += '<option value="' + player + '">' + player + '</option>';
                for (i = 0; i < characters.length; i++) {
                    tmp += '<option value="' + characters[i] + '">' + characters[i] + '</option>';
                }
                tmp = '<td><select name="character">' + tmp + '</select></td>';
                tmp_2.replaceWith(tmp);
            }
        } else if (data.cmd === 'PlayerQuit') {
            //console.dir(data);
        } else if (data.cmd === 'ChangeCharacter') {
            //console.dir(data);
        } else if (data.cmd === 'StartGame') {
            if (data.started) {
                window.location = '/game.html?id=' + game_id;
            } else {
                alert('Cannot start the game!');
            }
        } else if (data.cmd === 'KeepAlive') {
            alert('KEEP ALIVE!');
        }
    };

    $('#page-create form').on('submit', function () {
        var $this = $(this),
            style = $this.find('select[name="style"]'),
            server = $this.find('input[name="server"]'),
            password = $this.find('input[name="password"]');

        return false;
    });

    var interval_id = setInterval(function () {
        ws.send(JSON.stringify({
            cmd: 'QueryGames',
            playStyle: '',
            secured: ''
        }));
    }, 2000);

});
</script>
</body>
</html>