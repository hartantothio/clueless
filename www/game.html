<!DOCTYPE html>
<!--[if lt IE 7]>      <html class="no-js lt-ie9 lt-ie8 lt-ie7"> <![endif]-->
<!--[if IE 7]>         <html class="no-js lt-ie9 lt-ie8"> <![endif]-->
<!--[if IE 8]>         <html class="no-js lt-ie9"> <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js"> <!--<![endif]-->
<head>
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<title>Clueless</title>
<meta name="description" content="">
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="stylesheet" href="/css/jquery.fancybox.css" />
<link rel="stylesheet" href="/css/style.css" />
<body>

<h2 id="title"></h2>

<div id="container">
    <div id="canvas"></div>
    <div id="sidebar">
        <div id="notification-system" class="notification notification-system"></div>
        <div id="notification-chat" class="notification"></div>
        <form method="post" action="" id="chat">
            <input type="text" name="message" />
        </form>
    </div>
    <div class="clear"></div>
    <ul class="menu">
        <li><a id="btn-accuse-suggest" href="#game-accuse-suggest" id="btn-accuse-suggest">Suggest/Accuse</a></li>
        <!--<li><a href="#game-menu" data-toggle="modal">Menu</a></li>-->
        <li><a id="btn-endturn" href="#game-endturn">End Turn</a></li>
        <li><a id="btn-quit" href="#game-quit">Quit</a></li>
    </ul>
    <div id="clues">
        <h3>My Clues</h3>
        <ul></ul>
    </div>
</div>

<div class="modal"><div id="game-pad">
    <p>Detective Pad</p>
</div></div>

<div class="modal"><div id="game-menu" class="box">
    <h2>Game Menu</h2>
    <form action="" method="post">
        <div class="control-group">
            <label>Language: </label>
            <div class="control">
                <select name="language">
                    <option value="English">English</option>
               </select>
            </div>
        </div>
        <div class="control-group">
            <label>Sound: </label>
            <div class="control">
                <select name="sound">
                    <option value="1">On</option>
                    <option value="0">Off</option>
               </select>
            </div>
        </div>
        <div class="form-actions">
            <ul class="menu">
                <li><a href="#" class="modal-close">Back</a></li>
            </ul>
        </div>
    </form>
</div></div>

<div class="modal"><div id="game-accuse-suggest" class="box">
    <h2>Suggest/Accuse</h2>
    <form action="" method="post">
        <div class="control-group">
            <label>Action: </label>
            <div class="control">
                <select name="action">
                    <option value="accuse">Accuse</option>
               </select>
            </div>
        </div>
        <div class="control-group">
            <label>Character: </label>
            <div class="control">
                <select name="character">
                    <option value="Mr. Green">Mr. Green</option>
                    <option value="Miss Scarlet">Miss Scarlet</option>
                    <option value="Professor Plum">Professor Plum</option>
                    <option value="Ms. Peacock">Ms. Peacock</option>
                    <option value="Mrs. White">Mrs. White</option>
                    <option value="Colonel Mustard">Colonel Mustard</option>
               </select>
            </div>
        </div>
        <div class="control-group">
            <label>Weapon: </label>
            <div class="control">
                <select name="weapon">
                    <option value="Rope">Rope</option>
                    <option value="Lead Pipe">Lead Pipe</option>
                    <option value="Knife">Knife</option>
                    <option value="Wrench">Wrench</option>
                    <option value="Candlestick">Candlestick</option>
                    <option value="Revolver">Revolver</option>
               </select>
            </div>
        </div>
        <div class="control-group room">
            <label>Room: </label>
            <div class="control">
                <select name="room">
                    <option value="Study">Study</option>
                    <option value="Hall">Hall</option>
                    <option value="Lounge">Lounge</option>
                    <option value="Library">Library</option>
                    <option value="Billiard Room">Billiard Room</option>
                    <option value="Dining Room">Dining Room</option>
                    <option value="Conservatory">Conservatory</option>
                    <option value="Ballroom">Ballroom</option>
                    <option value="Kitchen">Kitchen</option>
               </select>
            </div>
        </div>
        <div class="form-actions">
            <ul class="menu">
                <li><a href="#" class="modal-close">Back</a></li>
                <li><input type="submit" id="btn-submit-accuse-suggest" class="submit" value="Submit" /></li>
            </ul>
        </div>
    </form>
</div></div>

<div class="modal"><div id="game-disprove-suggest" class="box">
    <h2>Disprove Suggestion</h2>
    <form action="" method="post">
        <div class="control-group">
            <label>Clues: </label>
            <div class="control">
                <select name="clues"></select>
            </div>
        </div>
        <div class="form-actions">
            <ul class="menu">
                <li><input type="submit" id="btn-submit-disprove-suggest" class="submit" value="Submit" /></li>
            </ul>
        </div>
    </form>
</div></div>

<div class="modal"><div id="game-disprove-accuse" class="box">
    <h2>Disprove Accusation</h2>
    <form action="" method="post">
        <div class="control-group">
            <label>Clues: </label>
            <div class="control">
                <select name="clues"></select>
            </div>
        </div>
        <div class="form-actions">
            <ul class="menu">
                <li><a href="#" class="modal-close">Back</a></li>
                <li><input type="submit" id="btn-submit-disprove-accuse" class="submit" value="Submit" /></li>
            </ul>
        </div>
    </form>
</div></div>

</body>
<script src="//ajax.googleapis.com/ajax/libs/jquery/1.10.2/jquery.min.js"></script>
<script>window.jQuery || document.write('<script src="/js/jquery-1.10.2.min.js"><\/script>')</script>
<script src="/js/jquery.cookie.js"></script>
<script src="/js/jquery.fancybox.min.js"></script>
<script src="/js/plugin.js"></script>
<script src="/js/svg.min.js"></script>
<script>
var APP = {};
    APP.Draw = SVG('canvas'); // my canvas object
    APP.Passages = {};
    APP.Hallways = {};
    APP.Characters = {},
    APP.Me = {},
    ws = new WebSocket("ws://home.mbajoras.net:8080/CluelessV1/CluelessServlet"),
    me_id = +$.cookie('player_id'),
    game_id = +getUrlVars()['id'],
    creator_id = null,
    $notification_system = $('#notification-system'),
    $notification_chat = $('#notification-chat'),
    $btn_accuse_suggest = $('#btn-accuse-suggest'),
    $btn_endturn = $('#btn-endturn'),
    APP.Suggestion = {
        'character': null,
        'room': null,
        'weapon': null
    };
</script>
<script src="/js/draw.js"></script>
<script src="/js/main.js?111"></script>
<script>
function updateGame(game) {
    // update title
    $('#title').html(game.name);
    creator_id = +game.creatorId;
} // updateGame()

function toggleGameTurn(show) {
    if (show === true) {
        $btn_accuse_suggest.show();
        $btn_endturn.show();
        $body.on('mouseenter mouseleave click', 'rect', function (e) {
            if (APP.Me.can_move) {
                var $this = $(this),
                    room  = $this.data('id');

                if ($this.data('type') === 'passage') {
                    room  = getHiddenPassageDestination(room);
                    $this = $('rect[data-id="' + room + '"]');
                }

                if (canMove(room)) {
                    switch (e.type) {
                        case 'mouseenter':
                            $this.attr('class', 'active');
                            break;
                        case 'mouseleave':
                            $this.attr('class', '');
                            break;
                        case 'click':
                            $this.attr('class', '');
                            disableMove();

                            updateCharacter(APP.Me.character, room);
                            moveCharacter(APP.Me.character, room);
                            if (isLocationHallway(room)) {
                                disableSuggest();
                            }

                            ws.send(JSON.stringify({
                                cmd: 'PlayerMove',
                                playerId: me_id,
                                gameId: game_id,
                                room: room
                            }));
                            break;
                    }
                }
            }
        });
    } else {
        $btn_accuse_suggest.hide();
        $btn_endturn.hide();
        $body.off('mouseenter mouseleave click', 'rect');
    }
} // updateGameTurn()

ws.onopen = function () {
    ws.send(JSON.stringify({
        cmd: 'KeepAlive',
        playerId: me_id,
        gameId: game_id
    }));

    ws.send(JSON.stringify({
        cmd: 'QueryGames',
        playerId: me_id,
        gameId: game_id,
        playStyle: '',
    }));
};

ws.onmessage = function(message) {
    var data = JSON.parse(message.data),
        i = 0, j = 0,
        tmp = '';
        //tmp_2 = '';
console.dir(data);
    if (data.cmd === 'KeepAlive') {

    } else if (data.cmd === 'PlayerMoved') {
        addSystemNotification(data.msg);
    } else if (data.cmd === 'PlayerMove') {
        if (+data.playerId !== me_id) {
            for (i in APP.Players) {
                if (APP.Players[i]['id'] ===  +data.playerId) {
                    updateCharacter(i, data.room);
                    moveCharacter(i, data.room);
                }
            }
        }
    } else if (data.cmd === 'PlayerChat') {
        if (!data.playerId) {
            addChatNotification(data.msg);
        }
    } else if (data.cmd === 'PlayerQuit') {
        /*
        PlayerQuitNotice
        */
        if (+data.playerId === me_id) {
            window.location = '/';
        }
    } else if (data.cmd === 'PlayerQuitNotice') {
        addSystemNotification(data.msg);
    } else if (data.cmd === 'EndTurn') {
        /*
        PlayerEndTurn
        GameUpdate
        PlayerGetTurn
        */
        toggleGameTurn(false);
    } else if (data.cmd === 'PlayerEndTurn') {
        addSystemNotification(data.msg);
    } else if (data.cmd === 'PlayerGetTurn') {
        addSystemNotification(data.msg);
    } else if (data.cmd === 'QueryGames') {
        // first time
        if (data.games && data.games.length) {
            for (i = 0; i < data.games.length; i++) {
                if (data.games[i].id === game_id) {
                    updateGame(data.games[i]);

                    if (+data.games[i].currentPlayer === me_id) {
                        toggleGameTurn(true);
                    } else {
                        toggleGameTurn(false);
                    }

                    // print out my character
                    for (j = 0; j < data.games[i].players.length; j++) {
                        if (me_id === +data.games[i].players[j].id) {
                            addSystemNotification('You are ' + data.games[i].players[j].character + '.');

                            APP.Me = {
                                character: data.games[i].players[j].character,
                                id: +data.games[i].players[j].id,
                                can_move: false,
                                can_suggest: false
                            };
                            break;
                        }
                    }

                    // print out the turn
                    for (j = 0; j < data.games[i].players.length; j++) {
                        if (+data.games[i].players[j].id === +data.games[i].currentPlayer) {
                            addSystemNotification('It is now ' + data.games[i].players[j].character + '\'s turn.');

                            if (APP.Me.id === +data.games[i].currentPlayer) {
                                enableMove();
                                enableSuggest();
                            }
                            break;
                        }
                    }

                    init();

                    // store player_id
                    for (j = 0; j < data.games[i].players.length; j++) {
                        APP.Players[data.games[i].players[j].character]['id'] = +data.games[i].players[j].id;
                    }

                    // get my own clues
                    ws.send(JSON.stringify({
                        cmd: 'GetClues',
                        playerId: me_id,
                        gameId: game_id
                    }));
                    break;
                }
            }
        }
    } else if (data.cmd === 'GameUpdate') {
        if (me_id === +data.gameInfo.currentPlayer) {
            enableMove();
            enableSuggest();
            toggleGameTurn(true);
        }
    } else if (data.cmd === 'GetClues') {
        APP.Me.clues = data.clues;
        for (i = 0; i < APP.Me.clues.length; i++) {
            tmp += '<li>' + APP.Me.clues[i].name + '</li>';
            //tmp_2 += '<option value="' + APP.Me.clues[i].name + '">' + APP.Me.clues[i].name + '</option>';
        }
        $('#clues ul').append(tmp);
        //$('select[name="clues"]').append(tmp_2);
    } else if (data.cmd === 'PlayerMustDisprove') {
        for (i = 0; i < APP.Me.clues.length; i++) {
            if (APP.Me.clues[i].name === data.character ||
                APP.Me.clues[i].name === data.weapon ||
                APP.Me.clues[i].name === data.room
            ) {
                tmp += '<option value="'+ APP.Me.clues[i].name +'">' + APP.Me.clues[i].name + '</option>';
            }
        }

        $('select[name="clues"]').html(tmp);
        $(window).scrollTop(0);
        $.fancybox({
            'centerOnScroll': true,
            'hideOnOverlayClick': false,
            'showCloseButton': false,
            'enableEscapeButton': false,
            'content': $('#game-disprove-suggest')[0].outerHTML,
        });
    } else if (data.cmd === 'PlayerMadeSuggestion' ||
        data.cmd === 'PlayerDisprovedSuggestionWithClue' ||
        data.cmd === 'PlayerDisprovedSuggestion' ||
        data.cmd === 'PlayerFailedToDisproveSuggestion' ||
        data.cmd === 'PlayerMadeAccusation'
    ) {
        addSystemNotification(data.msg);
    } else if (data.cmd === 'PlayerSuggest') {
        APP.Suggestion = {
            'character': data.character,
            'room': data.room,
            'weapon': data.weapon
        };

        if (+data.playerId !== me_id) {
            updateCharacter(data.character, data.room);
            moveCharacter(data.character, data.room);
        }
    } else if (data.cmd === 'PlayerAccuse') {
        if (data.correct === false) {
            disableMove();
            $('#btn-accuse-suggest').hide();
            $('#btn-endturn').hide();
        }
    } else if (data.cmd === 'PlayerAccusationCorrect') {
        addSystemNotification(data.msg);
        disableMove();
        $('#btn-endturn').hide();
        $('#btn-accuse-suggest').hide();
    } else if (data.cmd === 'PlayerAccusationIncorrect') {
        addSystemNotification(data.msg);
    }

};

$body.on('submit', '#game-disprove-suggest', function () {
    var clue = $(this).find('select[name="clues"]').val(),
        data = {
            cmd: 'PlayerSuggest',
            playerId: me_id,
            gameId: game_id,
            disproving: true
        };

    if (APP.Rooms[clue]) {
        data['room'] = clue;
    } else if (APP.Characters[clue]) {
        data['character'] = clue;
    } else {
        data['weapon'] = clue;
    }

    ws.send(JSON.stringify(data));
    closeModal();
    return false;
});


$('form#chat').on('submit', function () {
    var $message = $(this).find('input[name="message"]'),
        message = $message.val().trim();

    if (message) {
        ws.send(JSON.stringify({
            cmd: 'PlayerChat',
            gameId: game_id,
            playerId: me_id,
            msg: $message.val()
        }));

        // empty out the message
        $message.val('');
    }

    return false;
});

$('#btn-quit').on('click', function () {
    if (confirm('Are you sure you want to quit?')) {
        ws.send(JSON.stringify({
            cmd: 'PlayerQuit',
            gameId: game_id,
            playerId: me_id
        }));
    }
    return false;
});

$('#btn-endturn').on('click', function () {
    if (confirm('Are you sure you want to end your turn?')) {
        ws.send(JSON.stringify({
            cmd: 'EndTurn',
            gameId: game_id,
            playerId: me_id
        }));
    }
    return false;
});

/* suggest/accuse */
/*
var $game_accuse_suggest = $('#game-accuse-suggest');
$body.on('click', '#submit-suggest', function () {
    var character = $('#game-accuse-suggest').find('select[name="character"] :selected').text(),
        weapon = $game_accuse_suggest.find('select[name="weapon"] option:selected').text(),
        room = $game_accuse_suggest.find('select[name="room"] option:selected').text();

    if (confirm('Suggest ' + character + ' of murder in the ' + room + ' with the ' + weapon)) {
        disableSuggest();
        closeModal();
    }
});

$body.on('click', '#submit-accuse', function () {
    return false;
    var character = $game_accuse_suggest.find('select[name="character"] option:selected').text(),
        weapon = $game_accuse_suggest.find('select[name="weapon"] option:selected').text(),
        room = $game_accuse_suggest.find('select[name="room"] option:selected').text();

    return confirm('Accuse ' + character + ' of murder in the ' + room + ' with the ' + weapon);
});
*/

/* suggest/accuse */
$('#btn-accuse-suggest').on('click', function () {
    $.fancybox({
        'centerOnScroll': true,
        'content': $($(this).attr('href'))[0].outerHTML,
        'onComplete': function () {
            $('select[name="action"]').change();
        }
    });
    return false;
});

$body.on('submit', '#game-accuse-suggest form', function () {
    var $this = $(this),
        action = $this.find('select[name="action"]').val(),
        short_character = $this.find('select[name="character"]').val(),
        long_character = $this.find('select[name="character"] option:selected').text(),
        room = null;
        weapon = $this.find('select[name="weapon"]').val();

    if (action === 'suggest') {
        room = APP.Players[APP.Me.character].location;
        if (confirm('Suggest ' + long_character + ' of murder in the ' + room + ' with the ' + weapon)) {
            moveCharacter(short_character, APP.Players[APP.Me.character].location);
            closeModal();
            disableSuggest();
            ws.send(JSON.stringify({
                cmd: 'PlayerSuggest',
                playerId: me_id,
                gameId: game_id,
                character: long_character,
                room: room,
                weapon: weapon
            }));
        }
    } else {
        room = $this.find('select[name="room"]').val();
        if (confirm('Accuse ' + long_character + ' of murder in the ' + room + ' with the ' + weapon)) {
            closeModal();
            disableSuggest();
            ws.send(JSON.stringify({
                cmd: 'PlayerAccuse',
                playerId: me_id,
                gameId: game_id,
                character: long_character,
                room: room,
                weapon: weapon
            }));
        }
    }

    return false;
});

$body.on('change', 'select[name="action"]', function () {
    if (this.value === 'accuse') {
        $('#game-accuse-suggest .room').show();
    } else {
        $('#game-accuse-suggest .room').hide();
    }
});

</script>
</body>
</html>






